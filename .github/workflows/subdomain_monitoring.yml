name: Subdomain Monitoring Workflow

on:
  schedule:
    # Run every 12 hours
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl wget git jq
          pip install 'httpx[cli]'
          ./scripts/setup.sh

      - name: Cache tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            ~/local/bin
            SubEnum
            ~/.config/subfinder
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

  deutsche_telekom_enumeration:
    runs-on: ubuntu-latest
    needs: setup
    if: always()
    timeout-minutes: 120  # 2 hours
    outputs:
      completed: ${{ steps.check.outputs.completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Restore cached tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            ~/local/bin
            SubEnum
            ~/.config/subfinder
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

      - name: Add tools to PATH
        run: |
          echo "~/go/bin" >> $GITHUB_PATH
          echo "~/local/bin" >> $GITHUB_PATH

      - name: Check if enumeration already completed
        id: check
        run: |
          if [ -f "Deutsche_Telekom/results/all_subdomains.txt" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "[*] Subdomain enumeration already completed, skipping..."
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "[*] Running subdomain enumeration..."
          fi

      - name: Run subdomain enumeration for Deutsche Telekom
        if: steps.check.outputs.completed == 'false'
        env:
          BEVIGIL_API_KEY: ${{ secrets.BEVIGIL_API_KEY }}
          PDCP_API_KEY: ${{ secrets.PDCP_API_KEY }}
          FOFA_API_KEY: ${{ secrets.FOFA_API_KEY }}
          SUBFINDER_GITHUB_TOKEN: ${{ secrets.SUBFINDER_GITHUB_TOKEN }}
          INTELX_API_KEY: ${{ secrets.INTELX_API_KEY }}
          SECURITYTRAILS_API_KEY: ${{ secrets.SECURITYTRAILS_API_KEY }}
          SHODAN_API_KEY: ${{ secrets.SHODAN_API_KEY }}
          VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
          ZOOMEYE_API_KEY: ${{ secrets.ZOOMEYE_API_KEY }}
        run: |
          ./scripts/enumerate_subdomains.sh "Deutsche_Telekom"

      - name: Upload enumeration results
        uses: actions/upload-artifact@v4
        with:
          name: deutsche-telekom-enumeration
          path: Deutsche_Telekom/results/
          retention-days: 7

  deutsche_telekom_probing:
    runs-on: ubuntu-latest
    needs: deutsche_telekom_enumeration
    if: always() && (needs.deutsche_telekom_enumeration.result == 'success' || needs.deutsche_telekom_enumeration.outputs.completed == 'true')
    timeout-minutes: 120  # 2 hours
    outputs:
      completed: ${{ steps.check.outputs.completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Restore cached tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            ~/local/bin
            SubEnum
            ~/.config/subfinder
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

      - name: Add tools to PATH
        run: |
          echo "~/go/bin" >> $GITHUB_PATH
          echo "~/local/bin" >> $GITHUB_PATH

      - name: Download enumeration results
        uses: actions/download-artifact@v4
        with:
          name: deutsche-telekom-enumeration
          path: Deutsche_Telekom/results/

      - name: Check if probing already completed
        id: check
        run: |
          if [ -f "Deutsche_Telekom/results/live_subdomains.txt" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "[*] Probing already completed, skipping..."
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "[*] Running probing..."
          fi

      - name: Run probing for Deutsche Telekom
        if: steps.check.outputs.completed == 'false'
        env:
          DISCORD_WEBHOOK_DEUTSCHE_TELEKOM: ${{ secrets.DISCORD_WEBHOOK_TELEKOM }}
        run: |
          ./scripts/probe_subdomains.sh "Deutsche_Telekom"

      - name: Upload probing results
        uses: actions/upload-artifact@v4
        with:
          name: deutsche-telekom-probing
          path: Deutsche_Telekom/results/
          retention-days: 7

  deutsche_telekom_scanning:
    runs-on: ubuntu-latest
    needs: deutsche_telekom_probing
    if: always() && (needs.deutsche_telekom_probing.result == 'success' || needs.deutsche_telekom_probing.outputs.completed == 'true')
    timeout-minutes: 120  # 2 hours
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Restore cached tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            ~/local/bin
            SubEnum
            ~/.config/subfinder
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

      - name: Add tools to PATH
        run: |
          echo "~/go/bin" >> $GITHUB_PATH
          echo "~/local/bin" >> $GITHUB_PATH

      - name: Download probing results
        uses: actions/download-artifact@v4
        with:
          name: deutsche-telekom-probing
          path: Deutsche_Telekom/results/

      - name: Check if scanning already completed
        id: check
        run: |
          if [ -f "Deutsche_Telekom/results/nuclei_results.txt" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "[*] Nuclei scanning already completed, skipping..."
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "[*] Running Nuclei scanning..."
          fi

      - name: Run Nuclei scanning for Deutsche Telekom
        if: steps.check.outputs.completed == 'false'
        env:
          DISCORD_WEBHOOK_DEUTSCHE_TELEKOM: ${{ secrets.DISCORD_WEBHOOK_TELEKOM }}
        run: |
          ./scripts/scan_with_nuclei.sh "Deutsche_Telekom"

      - name: Upload scanning results
        uses: actions/upload-artifact@v4
        with:
          name: deutsche-telekom-scanning
          path: Deutsche_Telekom/results/
          retention-days: 7

  bitdefender_enumeration:
    runs-on: ubuntu-latest
    needs: setup
    if: always()
    timeout-minutes: 120  # 2 hours
    outputs:
      completed: ${{ steps.check.outputs.completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Restore cached tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            ~/local/bin
            SubEnum
            ~/.config/subfinder
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

      - name: Add tools to PATH
        run: |
          echo "~/go/bin" >> $GITHUB_PATH
          echo "~/local/bin" >> $GITHUB_PATH

      - name: Check if enumeration already completed
        id: check
        run: |
          if [ -f "Bitdefender/results/all_subdomains.txt" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "[*] Subdomain enumeration already completed, skipping..."
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "[*] Running subdomain enumeration..."
          fi

      - name: Run subdomain enumeration for Bitdefender
        if: steps.check.outputs.completed == 'false'
        env:
          BEVIGIL_API_KEY: ${{ secrets.BEVIGIL_API_KEY }}
          PDCP_API_KEY: ${{ secrets.PDCP_API_KEY }}
          FOFA_API_KEY: ${{ secrets.FOFA_API_KEY }}
          SUBFINDER_GITHUB_TOKEN: ${{ secrets.SUBFINDER_GITHUB_TOKEN }}
          INTELX_API_KEY: ${{ secrets.INTELX_API_KEY }}
          SECURITYTRAILS_API_KEY: ${{ secrets.SECURITYTRAILS_API_KEY }}
          SHODAN_API_KEY: ${{ secrets.SHODAN_API_KEY }}
          VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
          ZOOMEYE_API_KEY: ${{ secrets.ZOOMEYE_API_KEY }}
        run: |
          ./scripts/enumerate_subdomains.sh "Bitdefender"

      - name: Upload enumeration results
        uses: actions/upload-artifact@v4
        with:
          name: bitdefender-enumeration
          path: Bitdefender/results/
          retention-days: 7

  bitdefender_probing:
    runs-on: ubuntu-latest
    needs: bitdefender_enumeration
    if: always() && (needs.bitdefender_enumeration.result == 'success' || needs.bitdefender_enumeration.outputs.completed == 'true')
    timeout-minutes: 120  # 2 hours
    outputs:
      completed: ${{ steps.check.outputs.completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Restore cached tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            ~/local/bin
            SubEnum
            ~/.config/subfinder
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

      - name: Add tools to PATH
        run: |
          echo "~/go/bin" >> $GITHUB_PATH
          echo "~/local/bin" >> $GITHUB_PATH

      - name: Download enumeration results
        uses: actions/download-artifact@v4
        with:
          name: bitdefender-enumeration
          path: Bitdefender/results/

      - name: Check if probing already completed
        id: check
        run: |
          if [ -f "Bitdefender/results/live_subdomains.txt" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "[*] Probing already completed, skipping..."
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "[*] Running probing..."
          fi

      - name: Run probing for Bitdefender
        if: steps.check.outputs.completed == 'false'
        env:
          DISCORD_WEBHOOK_BITDEFENDER: ${{ secrets.DISCORD_WEBHOOK_BITDEFENDER }}
        run: |
          ./scripts/probe_subdomains.sh "Bitdefender"

      - name: Upload probing results
        uses: actions/upload-artifact@v4
        with:
          name: bitdefender-probing
          path: Bitdefender/results/
          retention-days: 7

  bitdefender_scanning:
    runs-on: ubuntu-latest
    needs: bitdefender_probing
    if: always() && (needs.bitdefender_probing.result == 'success' || needs.bitdefender_probing.outputs.completed == 'true')
    timeout-minutes: 120  # 2 hours
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Restore cached tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            ~/local/bin
            SubEnum
            ~/.config/subfinder
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

      - name: Add tools to PATH
        run: |
          echo "~/go/bin" >> $GITHUB_PATH
          echo "~/local/bin" >> $GITHUB_PATH

      - name: Download probing results
        uses: actions/download-artifact@v4
        with:
          name: bitdefender-probing
          path: Bitdefender/results/

      - name: Check if scanning already completed
        id: check
        run: |
          if [ -f "Bitdefender/results/nuclei_results.txt" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "[*] Nuclei scanning already completed, skipping..."
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "[*] Running Nuclei scanning..."
          fi

      - name: Run Nuclei scanning for Bitdefender
        if: steps.check.outputs.completed == 'false'
        env:
          DISCORD_WEBHOOK_BITDEFENDER: ${{ secrets.DISCORD_WEBHOOK_BITDEFENDER }}
        run: |
          ./scripts/scan_with_nuclei.sh "Bitdefender"

      - name: Upload scanning results
        uses: actions/upload-artifact@v4
        with:
          name: bitdefender-scanning
          path: Bitdefender/results/
          retention-days: 7

  archive:
    runs-on: ubuntu-latest
    needs: [deutsche_telekom_scanning, bitdefender_scanning]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create archive
        run: |
          mkdir -p archive
          if [ -d "artifacts/deutsche-telekom-enumeration" ]; then
            cp -r artifacts/deutsche-telekom-enumeration archive/Deutsche_Telekom_$(date +%Y%m%d_%H%M%S)
          fi
          if [ -d "artifacts/deutsche-telekom-probing" ]; then
            cp -r artifacts/deutsche-telekom-probing archive/Deutsche_Telekom_probing_$(date +%Y%m%d_%H%M%S)
          fi
          if [ -d "artifacts/deutsche-telekom-scanning" ]; then
            cp -r artifacts/deutsche-telekom-scanning archive/Deutsche_Telekom_scanning_$(date +%Y%m%d_%H%M%S)
          fi
          if [ -d "artifacts/bitdefender-enumeration" ]; then
            cp -r artifacts/bitdefender-enumeration archive/Bitdefender_$(date +%Y%m%d_%H%M%S)
          fi
          if [ -d "artifacts/bitdefender-probing" ]; then
            cp -r artifacts/bitdefender-probing archive/Bitdefender_probing_$(date +%Y%m%d_%H%M%S)
          fi
          if [ -d "artifacts/bitdefender-scanning" ]; then
            cp -r artifacts/bitdefender-scanning archive/Bitdefender_scanning_$(date +%Y%m%d_%H%M%S)
          fi
          tar -czf archive_$(date +%Y%m%d_%H%M%S).tar.gz archive/

      - name: Send archive notification to Discord
        env:
          DISCORD_WEBHOOK_ARCHIVE: ${{ secrets.DISCORD_WEBHOOK_ARCHIVE }}
        run: |
          curl -H "Content-Type: application/json" -X POST -d "{\"content\":\"## Subdomain Monitoring Results Archive\\n\\nArchive created for the latest scan run.\\n\\nTimestamp: $(date)\"}" "$DISCORD_WEBHOOK_ARCHIVE"

      - name: Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: subdomain-monitoring-archive
          path: archive_*.tar.gz
          retention-days: 30
