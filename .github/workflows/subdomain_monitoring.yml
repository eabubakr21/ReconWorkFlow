name: Subdomain Monitoring Workflow

on:
  schedule:
    # Run every 12 hours
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.19'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl wget
          pip install 'httpx[cli]'
          ./scripts/setup.sh

      - name: Cache tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            /usr/local/bin/httpx-pd
            /usr/bin/findomain
            SubEnum
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

  deutsche_telekom:
    runs-on: ubuntu-latest
    needs: setup
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.19'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Restore cached tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            /usr/local/bin/httpx-pd
            /usr/bin/findomain
            SubEnum
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

      - name: Add tools to PATH
        run: |
          echo "~/go/bin" >> $GITHUB_PATH
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Run workflow for Deutsche Telekom
        env:
          BEVIGIL_API_KEY: ${{ secrets.BEVIGIL_API_KEY }}
          PDCP_API_KEY: ${{ secrets.PDCP_API_KEY }}
          FOFA_API_KEY: ${{ secrets.FOFA_API_KEY }}
          SUBFINDER_GITHUB_TOKEN: ${{ secrets.SUBFINDER_GITHUB_TOKEN }}
          INTELX_API_KEY: ${{ secrets.INTELX_API_KEY }}
          SECURITYTRAILS_API_KEY: ${{ secrets.SECURITYTRAILS_API_KEY }}
          SHODAN_API_KEY: ${{ secrets.SHODAN_API_KEY }}
          VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
          ZOOMEYE_API_KEY: ${{ secrets.ZOOMEYE_API_KEY }}
          DISCORD_WEBHOOK_DEUTSCHE_TELEKOM: ${{ secrets.DISCORD_WEBHOOK_TELEKOM }}
        run: |
          ./scripts/run_workflow.sh "Deutsche_Telekom"

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: deutsche-telekom-results
          path: Deutsche_Telekom/results/

  bitdefender:
    runs-on: ubuntu-latest
    needs: setup
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.19'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Restore cached tools
        uses: actions/cache@v3
        with:
          path: |
            ~/go/bin
            /usr/local/bin/httpx-pd
            /usr/bin/findomain
            SubEnum
          key: ${{ runner.os }}-tools-${{ hashFiles('scripts/setup.sh') }}

      - name: Add tools to PATH
        run: |
          echo "~/go/bin" >> $GITHUB_PATH
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Run workflow for Bitdefender
        env:
          BEVIGIL_API_KEY: ${{ secrets.BEVIGIL_API_KEY }}
          PDCP_API_KEY: ${{ secrets.PDCP_API_KEY }}
          FOFA_API_KEY: ${{ secrets.FOFA_API_KEY }}
          SUBFINDER_GITHUB_TOKEN: ${{ secrets.SUBFINDER_GITHUB_TOKEN }}
          INTELX_API_KEY: ${{ secrets.INTELX_API_KEY }}
          SECURITYTRAILS_API_KEY: ${{ secrets.SECURITYTRAILS_API_KEY }}
          SHODAN_API_KEY: ${{ secrets.SHODAN_API_KEY }}
          VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
          ZOOMEYE_API_KEY: ${{ secrets.ZOOMEYE_API_KEY }}
          DISCORD_WEBHOOK_BITDEFENDER: ${{ secrets.DISCORD_WEBHOOK_BITDEFENDER }}
        run: |
          ./scripts/run_workflow.sh "Bitdefender"

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: bitdefender-results
          path: Bitdefender/results/

  archive:
    runs-on: ubuntu-latest
    needs: [deutsche_telekom, bitdefender]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download artifacts
        uses: actions/download-artifact@v3

      - name: Create archive
        run: |
          mkdir -p archive
          cp -r deutsche-telekom-results archive/Deutsche_Telekom_$(date +%Y%m%d_%H%M%S)
          cp -r bitdefender-results archive/Bitdefender_$(date +%Y%m%d_%H%M%S)
          tar -czf archive_$(date +%Y%m%d_%H%M%S).tar.gz archive/

      - name: Send archive notification to Discord
        env:
          DISCORD_WEBHOOK_ARCHIVE: ${{ secrets.DISCORD_WEBHOOK_ARCHIVE }}
        run: |
          curl -H "Content-Type: application/json" -X POST -d "{\"content\":\"## Subdomain Monitoring Results Archive\\n\\nArchive created for the latest scan run.\\n\\nTimestamp: $(date)\"}" "$DISCORD_WEBHOOK_ARCHIVE"

      - name: Upload archive
        uses: actions/upload-artifact@v3
        with:
          name: subdomain-monitoring-archive
          path: archive_*.tar.gz
